name: ğŸ§ª Test Execution & Allure Report

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Main Dependencies
      run: |
        echo "ğŸ”§ Installing main application dependencies..."
        pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Main dependencies installed successfully"

    - name: ğŸ“¦ Install Test Dependencies
      run: |
        echo "ğŸ§ª Installing test framework dependencies..."
        pip install -r test/requirements.txt
        echo "âœ… Test dependencies installed successfully"

    - name: ğŸ“¦ Install Allure
      run: |
        echo "ğŸ“Š Installing Allure reporting tool..."
        # Install Allure using npm (most reliable method)
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        sudo npm install -g allure-commandline
        echo "âœ… Allure installed successfully"

    - name: ğŸš€ Start FastAPI Service
      run: |
        echo "ğŸš€ Starting FastAPI service..."
        cd /home/runner/work/framework_py_be/framework_py_be
        python main.py &
        SERVICE_PID=$!
        echo "SERVICE_PID=$SERVICE_PID" >> $GITHUB_ENV
        echo "â³ Waiting for service to start..."
        sleep 10
        
        # Health check with retry mechanism
        for i in {1..30}; do
          echo "ğŸ” Health check attempt $i/30..."
          if curl -f http://localhost:8000/health; then
            echo "âœ… Service is healthy and ready!"
            break
          else
            echo "â³ Service not ready yet, waiting..."
            sleep 2
          fi
          
          if [ $i -eq 30 ]; then
            echo "âŒ Service failed to start after 60 seconds"
            exit 1
          fi
        done

    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Starting test execution..."
        cd /home/runner/work/framework_py_be/framework_py_be
        
        # Create logs directory
        mkdir -p test/logs
        
        # Run tests with detailed logging
        python test/run_tests.py --env=localhost --type=all --no-report 2>&1 | tee test/logs/github_actions_test_execution.log
        
        # Check test exit code
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        echo "TEST_EXIT_CODE=$TEST_EXIT_CODE" >> $GITHUB_ENV
        
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "âœ… All tests passed successfully!"
        else
          echo "âŒ Some tests failed!"
        fi

    - name: ğŸ“Š Generate Allure Report
      if: always()
      run: |
        echo "ğŸ“Š Generating Allure report..."
        cd /home/runner/work/framework_py_be/framework_py_be
        
        # Generate Allure report
        allure generate test/reports/allure-results -o test/reports/allure-report --clean
        
        if [ -d "test/reports/allure-report" ]; then
          echo "âœ… Allure report generated successfully!"
          echo "ğŸ“ Report location: test/reports/allure-report/"
        else
          echo "âš ï¸ Allure report generation failed"
        fi

    - name: ğŸ“‹ Test Summary
      if: always()
      run: |
        echo "=========================================="
        echo "ğŸ“‹ TEST EXECUTION SUMMARY"
        echo "=========================================="
        echo "ğŸ• Execution Time: $(date)"
        echo "ğŸŒ Environment: localhost"
        echo "ğŸ§ª Test Type: all"
        echo "ğŸ“Š Test Status: ${{ env.TEST_EXIT_CODE == '0' && 'âœ… PASSED' || 'âŒ FAILED' }}"
        echo ""
        
        # Count test results if available
        if [ -d "test/reports/allure-results" ]; then
          TOTAL_TESTS=$(find test/reports/allure-results -name "*.json" | wc -l)
          echo "ğŸ“ˆ Total Test Cases: $TOTAL_TESTS"
        fi
        
        # Show recent test logs
        if [ -f "test/logs/github_actions_test_execution.log" ]; then
          echo ""
          echo "ğŸ“ Recent Test Logs:"
          echo "----------------------------------------"
          tail -20 test/logs/github_actions_test_execution.log
        fi
        
        echo "=========================================="

    - name: ğŸ›‘ Stop Service
      if: always()
      run: |
        echo "ğŸ›‘ Stopping FastAPI service..."
        if [ ! -z "$SERVICE_PID" ]; then
          kill $SERVICE_PID 2>/dev/null || true
          echo "âœ… Service stopped"
        fi

    - name: ğŸ“¤ Upload Test Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ github.run_number }}
        path: |
          test/logs/
          test/reports/pytest_report.html
        retention-days: 30

    - name: ğŸ“¤ Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report-${{ github.run_number }}
        path: test/reports/allure-report/
        retention-days: 30

    - name: ğŸ“¤ Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results-${{ github.run_number }}
        path: test/reports/allure-results/
        retention-days: 30

    - name: ğŸš¨ Test Results Summary
      if: always()
      run: |
        echo "=========================================="
        echo "ğŸ¯ FINAL TEST RESULTS"
        echo "=========================================="
        echo "ğŸ”— Workflow: ${{ github.workflow }}"
        echo "ğŸ“ Run ID: ${{ github.run_id }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸ“… Commit: ${{ github.sha }}"
        echo ""
        echo "ğŸ“Š Test Status: ${{ env.TEST_EXIT_CODE == '0' && 'âœ… ALL TESTS PASSED' || 'âŒ SOME TESTS FAILED' }}"
        echo ""
        echo "ğŸ“¦ Artifacts Generated:"
        echo "  â€¢ Test Logs: test-logs-${{ github.run_number }}"
        echo "  â€¢ Allure Report: allure-report-${{ github.run_number }}"
        echo "  â€¢ Allure Results: allure-results-${{ github.run_number }}"
        echo ""
        echo "ğŸ’¡ Download artifacts from the Actions tab to view detailed reports"
        echo "=========================================="

    - name: âŒ Fail on Test Failure
      if: env.TEST_EXIT_CODE != '0'
      run: |
        echo "âŒ Tests failed! Check the logs above for details."
        exit 1
